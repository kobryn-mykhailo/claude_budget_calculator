<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Project Budget Calculator â€” FPP</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { sans: ['DM Sans', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
      colors: {
        ink: { 50:'#f7f7f8',100:'#eeeef0',200:'#d9d9de',300:'#b5b5bf',400:'#8e8e9e',500:'#6f6f83',600:'#5a5a6b',700:'#494957',800:'#3e3e4a',900:'#272731',950:'#1a1a21' },
        accent: { DEFAULT:'#e85d26', light:'#ff8f5c', dark:'#c24010' },
        sea: { DEFAULT:'#2d7ff9', light:'#6ba5ff', dark:'#1a5fc0' },
        mint: { DEFAULT:'#20c997', light:'#63e6c4', dark:'#12a87d' }
      }
    }
  }
}
</script>
<style>
  * { box-sizing: border-box; }
  body { font-family: 'DM Sans', sans-serif; background: #f7f7f8; color: #272731; }
  .tab-active { border-bottom: 3px solid #e85d26; color: #e85d26; font-weight: 700; }
  .tab-inactive { border-bottom: 3px solid transparent; color: #6f6f83; }
  .tab-inactive:hover { color: #272731; border-color: #d9d9de; }
  input[type=number]::-webkit-inner-spin-button { opacity: 1; }
  .card { background: #fff; border: 1px solid #eeeef0; border-radius: 12px; }
  .metric-card { background: linear-gradient(135deg, #fff 0%, #f7f7f8 100%); }
  .phase-badge { font-size: 11px; font-weight: 600; padding: 2px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
  .phase-1 { background: #dbeafe; color: #1d4ed8; }
  .phase-2 { background: #fef3c7; color: #b45309; }
  .phase-3 { background: #d1fae5; color: #047857; }
  .phase-oos { background: #f3e8ff; color: #7c3aed; }
  .phase-post { background: #ffe4e6; color: #be123c; }
  .phase-prep { background: #e0e7ff; color: #4338ca; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
  .fade-in { animation: fadeIn 0.3s ease-out; }
  .risk-high { background: #fef2f2; border-left: 4px solid #ef4444; }
  .risk-med { background: #fffbeb; border-left: 4px solid #f59e0b; }
  .risk-low { background: #f0fdf4; border-left: 4px solid #22c55e; }
  .input-clean { border: 1px solid #d9d9de; border-radius: 8px; padding: 6px 10px; font-size: 14px; transition: border-color 0.15s; background: #fff; }
  .input-clean:focus { outline: none; border-color: #e85d26; box-shadow: 0 0 0 3px rgba(232,93,38,0.1); }
  select.input-clean { appearance: auto; }
  .btn-primary { background: #e85d26; color: #fff; border-radius: 8px; padding: 8px 20px; font-weight: 600; font-size: 14px; border: none; cursor: pointer; transition: all 0.15s; }
  .btn-primary:hover { background: #c24010; transform: translateY(-1px); }
  .btn-ghost { background: transparent; color: #6f6f83; border: 1px solid #d9d9de; border-radius: 8px; padding: 6px 14px; font-weight: 500; font-size: 13px; cursor: pointer; }
  .btn-ghost:hover { border-color: #8e8e9e; color: #272731; }
  .btn-danger { background: #fee2e2; color: #dc2626; border: none; border-radius: 8px; padding: 4px 10px; font-size: 12px; cursor: pointer; }
  .btn-danger:hover { background: #fecaca; }
  table.data-table { width: 100%; border-collapse: separate; border-spacing: 0; }
  table.data-table th { background: #f7f7f8; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #6f6f83; padding: 10px 12px; text-align: left; border-bottom: 2px solid #eeeef0; position: sticky; top: 0; z-index: 2; }
  table.data-table td { padding: 8px 12px; border-bottom: 1px solid #eeeef0; font-size: 14px; vertical-align: middle; }
  table.data-table tr:hover td { background: #f7f7f8; }
  .money { font-family: 'JetBrains Mono', monospace; font-size: 13px; }
  .tooltip { position: relative; }
  .tooltip:hover::after { content: attr(data-tip); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #272731; color: #fff; font-size: 12px; padding: 4px 8px; border-radius: 6px; white-space: nowrap; z-index: 50; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback, useRef } = React;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA MODELS & DEFAULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const PHASES = ['Phase 1','Phase 2','Phase 3','Post Release','Preparation','Out of Scope'];
const PHASE_CLASSES = {'Phase 1':'phase-1','Phase 2':'phase-2','Phase 3':'phase-3','Out of Scope':'phase-oos','Post Release':'phase-post','Preparation':'phase-prep'};
const ROLE_TYPES = ['DEV','QA','PM','Arch (mngt)','Tech Lead (mngt)','DevOps','BA','UI/UX','InfoDev'];

const defaultTeamMember = (role='DEV', position='') => ({
  id: crypto.randomUUID(), role, position, count: 1, monthlyInternal: 0, externalRate: 0, externalRateDiscount: 0
});

const defaultFeature = () => ({
  id: crypto.randomUUID(), group: '', name: '', description: '', phase: 'Phase 1',
  optimistic: 0, pessimistic: 0, mostLikely: 0, riskId: '', scopeRisk: '', mitigationActivity: false
});

const defaultRisk = () => ({
  id: crypto.randomUUID(), group: 'Scope', phase: 'Phase 1', risk: '', description: '',
  indicators: '', proposedActions: '', actionOwner: 'PM / EM', considerationType: 'Contingency reserve',
  estimateHours: 0, probability: 0
});

const defaultInputData = () => ({
  stabilizationPct: 0.10, contingencyPct: 0.05,
  prepWeeks: 1, prepWorkload: 1, prepMembers: 8,
  teamReleaseHoursPerPerson: 16,
  warrantyMonths: 0, warrantyWorkload: 0.25, warrantyMembers: 0,
  uatWorkload: 0.25, uatMembers: 2,
  knowledgeTransferHours: 0,
  hoursPerMonth: 168, weeksPerMonth: 4.3, discount: 0, dpmTarget: 0, amortizationPct: 0,
  expensesPctOfCogs: 0.04
});

const defaultProject = () => ({
  name: 'New Project',
  team: [
    defaultTeamMember('DEV','Senior Backend Developer'),
    defaultTeamMember('DEV','Senior Frontend Developer'),
    defaultTeamMember('QA','Senior Manual Test Engineer'),
    defaultTeamMember('PM','Middle Project Manager'),
    defaultTeamMember('Arch (mngt)','Application Architect'),
    defaultTeamMember('DevOps','Middle DevOps Engineer'),
    defaultTeamMember('BA','System Business Analyst'),
    defaultTeamMember('UI/UX','Middle UX Designer'),
    defaultTeamMember('InfoDev','Middle InfoDev'),
  ],
  features: [defaultFeature()],
  risks: [
    {...defaultRisk(), group:'HR', phase:'Phase 1', risk:'Unexpected leaves', description:'Unexpected absences of key team members or unplanned rotations.', indicators:'Default risk', proposedActions:'Contingency reserve: plan time and budget for rotations and substitution'},
    {...defaultRisk(), group:'HR', phase:'Phase 2', risk:'Individual performance', description:'Acquired specialists may underperform.', indicators:'Default risk', proposedActions:'Contingency reserve: plan time and budget for rotations.'},
    {...defaultRisk(), group:'Scope', phase:'Phase 3', risk:'Small changes', description:'Small scope adjustments up to 4 dev hours per task', indicators:'Default risk', proposedActions:'Contingency reserve: allocation for minor changes'},
  ],
  inputData: defaultInputData(),
  expenses: { equipment:0, customerVisit:0, businessTrips:0, bonuses:0, teamBuildings:0, education:0, licenses:0, infrastructure:0, other:0 }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULATION ENGINE (mirrors Excel formulas)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcBudget(project) {
  const { team, features, risks, inputData: inp, expenses } = project;
  const hpm = inp.hoursPerMonth || 168;

  // --- Team Rates ---
  const roleGroups = {};
  ROLE_TYPES.forEach(r => { roleGroups[r] = { count:0, totalRate:0, totalExtRate:0, totalExtRateDisc:0 }; });
  team.forEach(m => {
    const g = roleGroups[m.role];
    if (!g) return;
    const hourly = m.monthlyInternal / hpm;
    g.count += m.count;
    g.totalRate += hourly * m.count;
    g.totalExtRate += m.externalRate * m.count;
    g.totalExtRateDisc += (m.externalRateDiscount || m.externalRate * (1 - (inp.discount||0))) * m.count;
  });
  const totalTeamCount = Object.values(roleGroups).reduce((s,g) => s + g.count, 0);
  const teamHourlyRate = totalTeamCount > 0 ? Object.values(roleGroups).reduce((s,g) => s + g.totalRate, 0) / totalTeamCount : 0;
  const avgExtRate = totalTeamCount > 0 ? Object.values(roleGroups).reduce((s,g) => s + g.totalExtRate, 0) / totalTeamCount : 0;
  const avgExtRateDisc = totalTeamCount > 0 ? Object.values(roleGroups).reduce((s,g) => s + g.totalExtRateDisc, 0) / totalTeamCount : 0;

  const roleAvgRate = {};
  ROLE_TYPES.forEach(r => {
    const g = roleGroups[r];
    roleAvgRate[r] = g.count > 0 ? g.totalRate / g.count : 0;
  });
  const devCount = roleGroups['DEV'].count || 1;

  // Role allocation percentages (how many people of each role vs DEV count)
  const rolePct = {};
  ROLE_TYPES.forEach(r => { rolePct[r] = roleGroups[r].count / (devCount || 1); });

  // --- PERT Feature Estimation ---
  const featureCalcs = features.map(f => {
    const o = f.optimistic || 0, p = f.pessimistic || 0, m = f.mostLikely || 0;
    const expected = (o + p + 4*m) / 6;
    const stdDev = (p - o) / 6;
    const variance = stdDev * stdDev;
    const devHours = expected * 8;
    const riskFlag = (p - o) > o;
    return { ...f, expected, stdDev, variance, devHours, riskFlag };
  });

  // --- Phase-based Dev Hours ---
  const phaseDevHours = {};
  PHASES.forEach(ph => { phaseDevHours[ph] = 0; });
  featureCalcs.forEach(f => { phaseDevHours[f.phase] = (phaseDevHours[f.phase]||0) + f.devHours; });
  const totalDevHoursExec = (phaseDevHours['Phase 1']||0) + (phaseDevHours['Phase 2']||0) + (phaseDevHours['Phase 3']||0);
  const totalDevHoursAll = totalDevHoursExec + (phaseDevHours['Out of Scope']||0);

  // --- Effort Distribution per Role (mirroring Excel) ---
  // For each phase, distribute hours to all roles based on rolePct
  const phaseEfforts = {};
  PHASES.forEach(ph => {
    const devH = phaseDevHours[ph] || 0;
    const baseUnit = devCount > 0 ? devH / devCount : 0;
    phaseEfforts[ph] = {};
    ROLE_TYPES.forEach(r => {
      if (r === 'DEV') phaseEfforts[ph][r] = devH;
      else phaseEfforts[ph][r] = baseUnit * roleGroups[r].count;
    });
  });

  // --- Stabilization (% of execution efforts) ---
  const stabilization = {};
  ['Phase 1','Phase 2','Phase 3','Out of Scope'].forEach(ph => {
    const allEfforts = Object.values(phaseEfforts[ph] || {}).reduce((s,v) => s+v, 0);
    stabilization[ph] = allEfforts * (inp.stabilizationPct || 0);
  });
  const totalStabilization = Object.values(stabilization).reduce((s,v) => s+v, 0);

  // --- Contingency Reserve ---
  const riskEMVbyPhase = {};
  PHASES.forEach(ph => { riskEMVbyPhase[ph] = 0; });
  risks.forEach(r => {
    const emv = (r.estimateHours||0) * (r.probability||0);
    riskEMVbyPhase[r.phase] = (riskEMVbyPhase[r.phase]||0) + emv;
  });
  const contingency = {};
  ['Phase 1','Phase 2','Phase 3','Out of Scope'].forEach(ph => {
    const allEfforts = Object.values(phaseEfforts[ph] || {}).reduce((s,v) => s+v, 0);
    contingency[ph] = allEfforts * (inp.contingencyPct || 0) + (riskEMVbyPhase[ph]||0);
  });
  const totalContingency = Object.values(contingency).reduce((s,v) => s+v, 0);

  // --- Preparation Hours ---
  const prepBillable = (inp.prepWorkload||1) * 40 * (inp.prepMembers||8) * (inp.prepWeeks||1);
  const prepTotal = prepBillable; // simplified â€” non-billable added via overhead

  // --- Post-Release ---
  const warrantyHours = (inp.warrantyMonths||0) * hpm * (inp.warrantyMembers||0) * (inp.warrantyWorkload||0);
  const teamReleaseHours = (inp.teamReleaseHoursPerPerson||0) * totalTeamCount;

  // UAT hours per phase
  const uatHoursPerPhase = {};
  ['Phase 1','Phase 2','Phase 3','Out of Scope'].forEach(ph => {
    const devH = phaseDevHours[ph];
    if (devH <= 0) { uatHoursPerPhase[ph] = 0; return; }
    const monthsEquiv = devH / (hpm * devCount);
    const uatWeeks = monthsEquiv < 9 ? 2 : 4;
    uatHoursPerPhase[ph] = uatWeeks * 40 * (inp.uatMembers||0) * (inp.uatWorkload||0);
  });
  const totalUATHours = Object.values(uatHoursPerPhase).reduce((s,v) => s+v, 0);

  const knowledgeTransferHours = inp.knowledgeTransferHours || 0;
  const postReleaseHours = warrantyHours + teamReleaseHours + knowledgeTransferHours + totalUATHours;

  // --- Documentation (InfoDev) ---
  const infoDevHours = 0; // User fills in manually, currently 0

  // --- Total Hours Summary ---
  const totalExecutionHours = totalDevHoursExec + totalStabilization + totalContingency;
  const totalProjectHours = totalExecutionHours + prepTotal + postReleaseHours;

  // --- Cost Calculations ---
  const totalExpenses = Object.values(expenses).reduce((s,v) => s + (v||0), 0);
  const autoExpenses = totalExpenses <= 0 ? (inp.expensesPctOfCogs||0.04) * totalExecutionHours * teamHourlyRate : totalExpenses;

  const cogsBillable = totalProjectHours * teamHourlyRate;
  const cogsTotal = cogsBillable + autoExpenses;

  // Revenue calculations
  const revenueDPM = inp.dpmTarget > 0 ? cogsTotal / (1 - inp.dpmTarget) : cogsTotal;
  const revenueExtRate = totalProjectHours * avgExtRate;
  const revenueExtRateDisc = totalProjectHours * avgExtRateDisc;

  const dpmActual = revenueExtRate > 0 ? (revenueExtRate - cogsTotal) / revenueExtRate : 0;

  // --- Phase Breakdown for Dashboard ---
  const phaseBreakdown = {};
  ['Phase 1','Phase 2','Phase 3'].forEach(ph => {
    const devH = phaseDevHours[ph] || 0;
    const stabH = stabilization[ph] || 0;
    const contH = contingency[ph] || 0;
    const totalH = devH + stabH + contH;
    const cost = totalH * teamHourlyRate;
    const rev = totalH * avgExtRate;
    phaseBreakdown[ph] = { devHours: devH, stabHours: stabH, contHours: contH, totalHours: totalH, cost, revenue: rev };
  });

  // Project duration
  const execWeeks = totalTeamCount > 0 ? totalExecutionHours / (totalTeamCount * 40) : 0;
  const totalWeeks = execWeeks + (inp.prepWeeks||0) + (warrantyHours > 0 ? (inp.warrantyMonths||0) * 4.3 : 0);
  const totalMonths = totalWeeks / 4.3;

  // Risk summary
  const totalRiskEMV = risks.reduce((s,r) => s + (r.estimateHours||0) * (r.probability||0), 0);
  const totalRiskCost = totalRiskEMV * teamHourlyRate;

  return {
    featureCalcs, phaseDevHours, phaseEfforts, stabilization, contingency,
    totalStabilization, totalContingency, prepBillable, prepTotal, postReleaseHours,
    warrantyHours, teamReleaseHours, totalUATHours, knowledgeTransferHours,
    totalExecutionHours, totalProjectHours, cogsBillable, cogsTotal, autoExpenses,
    revenueDPM, revenueExtRate, revenueExtRateDisc, dpmActual,
    teamHourlyRate, avgExtRate, avgExtRateDisc, totalTeamCount, devCount,
    roleGroups, roleAvgRate, rolePct,
    phaseBreakdown, execWeeks, totalWeeks, totalMonths,
    riskEMVbyPhase, totalRiskEMV, totalRiskCost,
    totalDevHoursExec, totalDevHoursAll, infoDevHours, totalExpenses: autoExpenses
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY COMPONENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fmt = (n, dec=0) => {
  if (n === undefined || n === null || isNaN(n)) return 'â€”';
  return new Intl.NumberFormat('en-US', { minimumFractionDigits: dec, maximumFractionDigits: dec }).format(n);
};
const fmtMoney = (n) => n === undefined || isNaN(n) ? 'â€”' : '$' + fmt(n, 0);
const fmtPct = (n) => n === undefined || isNaN(n) ? 'â€”' : (n*100).toFixed(1) + '%';
const fmtHrs = (n) => fmt(n, 1) + 'h';

function NumInput({ value, onChange, min=0, step=1, className='', ...props }) {
  return <input type="number" value={value} onChange={e => onChange(parseFloat(e.target.value)||0)}
    min={min} step={step} className={`input-clean w-24 text-right ${className}`} {...props}/>;
}
function PctInput({ value, onChange, className='', ...props }) {
  return <input type="number" value={(value*100).toFixed(1)} onChange={e => onChange((parseFloat(e.target.value)||0)/100)}
    min={0} max={100} step={0.5} className={`input-clean w-20 text-right ${className}`} {...props}/>;
}
function TextInput({ value, onChange, className='', ...props }) {
  return <input type="text" value={value} onChange={e => onChange(e.target.value)}
    className={`input-clean ${className}`} {...props}/>;
}
function SelectInput({ value, onChange, options, className='', ...props }) {
  return <select value={value} onChange={e => onChange(e.target.value)} className={`input-clean ${className}`} {...props}>
    {options.map(o => <option key={o} value={o}>{o}</option>)}
  </select>;
}

function MetricCard({ label, value, sub, color='ink' }) {
  const colors = { ink:'border-ink-200', accent:'border-accent', sea:'border-sea', mint:'border-mint' };
  return (
    <div className={`metric-card card p-4 border-l-4 ${colors[color]||colors.ink}`}>
      <div className="text-xs font-semibold text-ink-400 uppercase tracking-wider mb-1">{label}</div>
      <div className="text-2xl font-bold money">{value}</div>
      {sub && <div className="text-xs text-ink-400 mt-1">{sub}</div>}
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: PROJECT TEAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function TeamTab({ project, setProject }) {
  const { team } = project;
  const addMember = () => setProject(p => ({...p, team: [...p.team, defaultTeamMember()]}));
  const updateMember = (id, field, val) => setProject(p => ({
    ...p, team: p.team.map(m => m.id === id ? {...m, [field]: val} : m)
  }));
  const removeMember = (id) => setProject(p => ({...p, team: p.team.filter(m => m.id !== id)}));

  return (
    <div className="fade-in">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h2 className="text-lg font-bold">Project Team</h2>
          <p className="text-sm text-ink-400">Define roles, headcount and rates for the project team</p>
        </div>
        <button onClick={addMember} className="btn-primary">+ Add Member</button>
      </div>
      <div className="card overflow-x-auto">
        <table className="data-table">
          <thead><tr>
            <th>Role</th><th>Position</th><th className="text-center">Count</th>
            <th className="text-right">Monthly Rate (Int)</th>
            <th className="text-right">Hourly Rate (Ext)</th>
            <th className="text-right">Hourly Disc. (Ext)</th>
            <th></th>
          </tr></thead>
          <tbody>
            {team.map(m => (
              <tr key={m.id}>
                <td><SelectInput value={m.role} onChange={v => updateMember(m.id,'role',v)} options={ROLE_TYPES} className="w-36"/></td>
                <td><TextInput value={m.position} onChange={v => updateMember(m.id,'position',v)} placeholder="e.g. Senior Backend Dev" className="w-48"/></td>
                <td className="text-center"><NumInput value={m.count} onChange={v => updateMember(m.id,'count',v)} min={1} className="w-16 text-center"/></td>
                <td className="text-right"><NumInput value={m.monthlyInternal} onChange={v => updateMember(m.id,'monthlyInternal',v)} step={100} className="w-28"/></td>
                <td className="text-right"><NumInput value={m.externalRate} onChange={v => updateMember(m.id,'externalRate',v)} step={5} className="w-24"/></td>
                <td className="text-right"><NumInput value={m.externalRateDiscount} onChange={v => updateMember(m.id,'externalRateDiscount',v)} step={5} className="w-24"/></td>
                <td><button onClick={() => removeMember(m.id)} className="btn-danger">âœ•</button></td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      <div className="mt-3 text-xs text-ink-400">
        Tip: Monthly Internal rate is used for COGS. External hourly rate is the billable rate to client. Leave discount rate at 0 to auto-calculate from discount %.
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: FEATURES ESTIMATE (PERT)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function FeaturesTab({ project, setProject, budget }) {
  const { features } = project;
  const addFeature = () => setProject(p => ({...p, features: [...p.features, defaultFeature()]}));
  const updateFeature = (id, field, val) => setProject(p => ({
    ...p, features: p.features.map(f => f.id === id ? {...f, [field]: val} : f)
  }));
  const removeFeature = (id) => setProject(p => ({...p, features: p.features.filter(f => f.id !== id)}));
  const duplicateFeature = (feat) => setProject(p => ({...p, features: [...p.features, {...feat, id: crypto.randomUUID(), name: feat.name + ' (copy)'}]}));

  const fc = budget.featureCalcs;

  return (
    <div className="fade-in">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h2 className="text-lg font-bold">Features Estimate</h2>
          <p className="text-sm text-ink-400">PERT 3-point estimation: Optimistic / Pessimistic / Most Likely (in man-days)</p>
        </div>
        <button onClick={addFeature} className="btn-primary">+ Add Feature</button>
      </div>

      <div className="grid grid-cols-4 gap-3 mb-4">
        <MetricCard label="Total Dev Hours" value={fmtHrs(budget.totalDevHoursAll)} color="sea"/>
        <MetricCard label="Features Count" value={features.length} color="ink"/>
        <MetricCard label="Avg Std Deviation" value={fmt(fc.reduce((s,f) => s+f.stdDev,0)/Math.max(fc.length,1), 2) + ' days'} color="accent"/>
        <MetricCard label="Risk Flags" value={fc.filter(f => f.riskFlag).length} sub="High variance features" color="accent"/>
      </div>

      <div className="card overflow-x-auto">
        <table className="data-table">
          <thead><tr>
            <th className="w-8">#</th>
            <th>Group</th><th>Feature</th><th>Phase</th>
            <th className="text-right">Optimistic</th>
            <th className="text-right">Pessimistic</th>
            <th className="text-right">Most Likely</th>
            <th className="text-right" style={{background:'#eef6ff'}}>Expected</th>
            <th className="text-right" style={{background:'#eef6ff'}}>Std Dev</th>
            <th className="text-right" style={{background:'#eef6ff'}}>Dev Hours</th>
            <th className="text-center">âš </th>
            <th></th>
          </tr></thead>
          <tbody>
            {fc.map((f, i) => (
              <tr key={f.id} className={f.riskFlag ? 'bg-red-50' : ''}>
                <td className="text-ink-400 text-xs">{i+1}</td>
                <td><TextInput value={f.group} onChange={v => updateFeature(f.id,'group',v)} placeholder="Module" className="w-28"/></td>
                <td><TextInput value={f.name} onChange={v => updateFeature(f.id,'name',v)} placeholder="Feature name" className="w-44"/></td>
                <td>
                  <SelectInput value={f.phase} onChange={v => updateFeature(f.id,'phase',v)}
                    options={['Phase 1','Phase 2','Phase 3','Out of Scope']} className="w-28"/>
                </td>
                <td className="text-right"><NumInput value={f.optimistic} onChange={v => updateFeature(f.id,'optimistic',v)} step={0.5} className="w-20"/></td>
                <td className="text-right"><NumInput value={f.pessimistic} onChange={v => updateFeature(f.id,'pessimistic',v)} step={0.5} className="w-20"/></td>
                <td className="text-right"><NumInput value={f.mostLikely} onChange={v => updateFeature(f.id,'mostLikely',v)} step={0.5} className="w-20"/></td>
                <td className="text-right money font-semibold" style={{background:'#f0f7ff'}}>{fmt(f.expected, 2)}</td>
                <td className="text-right money" style={{background:'#f0f7ff'}}>{fmt(f.stdDev, 2)}</td>
                <td className="text-right money font-semibold" style={{background:'#f0f7ff'}}>{fmtHrs(f.devHours)}</td>
                <td className="text-center">{f.riskFlag ? <span className="text-red-500 font-bold" title="High variance: (pessimistic-optimistic) > optimistic">âš </span> : ''}</td>
                <td className="flex gap-1">
                  <button onClick={() => duplicateFeature(f)} className="btn-ghost text-xs" title="Duplicate">â§‰</button>
                  <button onClick={() => removeFeature(f.id)} className="btn-danger">âœ•</button>
                </td>
              </tr>
            ))}
          </tbody>
          <tfoot>
            <tr className="font-bold" style={{background:'#f7f7f8'}}>
              <td colSpan={7} className="text-right">Totals:</td>
              <td className="text-right money">{fmt(fc.reduce((s,f)=>s+f.expected,0), 2)} days</td>
              <td></td>
              <td className="text-right money">{fmtHrs(fc.reduce((s,f)=>s+f.devHours,0))}</td>
              <td colSpan={2}></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div className="mt-4 grid grid-cols-4 gap-3">
        {['Phase 1','Phase 2','Phase 3','Out of Scope'].map(ph => (
          <div key={ph} className="card p-3">
            <span className={`phase-badge ${PHASE_CLASSES[ph]}`}>{ph}</span>
            <div className="mt-2 money text-lg font-bold">{fmtHrs(budget.phaseDevHours[ph]||0)}</div>
            <div className="text-xs text-ink-400">{fc.filter(f => f.phase === ph).length} features</div>
          </div>
        ))}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: RISKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function RisksTab({ project, setProject, budget }) {
  const { risks } = project;
  const addRisk = () => setProject(p => ({...p, risks: [...p.risks, defaultRisk()]}));
  const updateRisk = (id, field, val) => setProject(p => ({
    ...p, risks: p.risks.map(r => r.id === id ? {...r, [field]: val} : r)
  }));
  const removeRisk = (id) => setProject(p => ({...p, risks: p.risks.filter(r => r.id !== id)}));

  const riskCategories = ['HR','Scope','Tech','Customer','Other'];

  return (
    <div className="fade-in">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h2 className="text-lg font-bold">Project Level Risks</h2>
          <p className="text-sm text-ink-400">Risk register with contingency reserve calculation (EMV-based)</p>
        </div>
        <button onClick={addRisk} className="btn-primary">+ Add Risk</button>
      </div>

      <div className="grid grid-cols-3 gap-3 mb-4">
        <MetricCard label="Total Risks" value={risks.length} color="ink"/>
        <MetricCard label="Total EMV Hours" value={fmtHrs(budget.totalRiskEMV)} sub="Expected monetary value" color="accent"/>
        <MetricCard label="Contingency Reserve" value={fmtHrs(budget.totalContingency)} sub={`${fmtPct(project.inputData.contingencyPct)} of execution + EMV`} color="sea"/>
      </div>

      <div className="space-y-3">
        {risks.map((r, i) => {
          const emv = (r.estimateHours||0) * (r.probability||0);
          const severity = r.probability >= 0.5 ? 'risk-high' : r.probability >= 0.2 ? 'risk-med' : 'risk-low';
          return (
            <div key={r.id} className={`card p-4 ${severity}`}>
              <div className="flex items-start justify-between gap-4">
                <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-3">
                  <div>
                    <label className="text-xs font-semibold text-ink-400 block mb-1">Category</label>
                    <SelectInput value={r.group} onChange={v => updateRisk(r.id,'group',v)} options={riskCategories} className="w-full"/>
                  </div>
                  <div>
                    <label className="text-xs font-semibold text-ink-400 block mb-1">Phase</label>
                    <SelectInput value={r.phase} onChange={v => updateRisk(r.id,'phase',v)} options={PHASES} className="w-full"/>
                  </div>
                  <div className="col-span-2">
                    <label className="text-xs font-semibold text-ink-400 block mb-1">Risk</label>
                    <TextInput value={r.risk} onChange={v => updateRisk(r.id,'risk',v)} placeholder="Risk title" className="w-full"/>
                  </div>
                  <div className="col-span-2">
                    <label className="text-xs font-semibold text-ink-400 block mb-1">Description</label>
                    <TextInput value={r.description} onChange={v => updateRisk(r.id,'description',v)} placeholder="Details" className="w-full"/>
                  </div>
                  <div>
                    <label className="text-xs font-semibold text-ink-400 block mb-1">Estimate (hours)</label>
                    <NumInput value={r.estimateHours} onChange={v => updateRisk(r.id,'estimateHours',v)} className="w-full"/>
                  </div>
                  <div>
                    <label className="text-xs font-semibold text-ink-400 block mb-1">Probability %</label>
                    <PctInput value={r.probability} onChange={v => updateRisk(r.id,'probability',v)} className="w-full"/>
                  </div>
                </div>
                <div className="text-right shrink-0">
                  <div className="text-xs text-ink-400 mb-1">EMV</div>
                  <div className="money text-lg font-bold">{fmtHrs(emv)}</div>
                  {r.probability >= 0.5 && <div className="text-xs text-red-600 font-semibold mt-1">âš  High probability</div>}
                  <button onClick={() => removeRisk(r.id)} className="btn-danger mt-2">Remove</button>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: INPUT DATA / SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function InputDataTab({ project, setProject }) {
  const { inputData: inp, expenses } = project;
  const update = (field, val) => setProject(p => ({...p, inputData: {...p.inputData, [field]: val}}));
  const updateExp = (field, val) => setProject(p => ({...p, expenses: {...p.expenses, [field]: val}}));

  const Section = ({ title, children }) => (
    <div className="card p-5 mb-4">
      <h3 className="text-sm font-bold text-ink-500 uppercase tracking-wider mb-3 pb-2 border-b border-ink-100">{title}</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{children}</div>
    </div>
  );
  const Field = ({ label, tip, children }) => (
    <div>
      <label className="text-xs font-semibold text-ink-500 block mb-1">{label}</label>
      {children}
      {tip && <div className="text-xs text-ink-300 mt-1">{tip}</div>}
    </div>
  );

  return (
    <div className="fade-in">
      <h2 className="text-lg font-bold mb-1">Project Settings</h2>
      <p className="text-sm text-ink-400 mb-4">Parameters that control the budget calculation engine</p>

      <Section title="Stabilization & Contingency">
        <Field label="Stabilization %" tip="10% typical for FPP">
          <PctInput value={inp.stabilizationPct} onChange={v => update('stabilizationPct',v)} className="w-full"/>
        </Field>
        <Field label="Contingency Reserve %" tip="5-10% based on complexity">
          <PctInput value={inp.contingencyPct} onChange={v => update('contingencyPct',v)} className="w-full"/>
        </Field>
      </Section>

      <Section title="Project Preparation">
        <Field label="Preparation Weeks" tip="1 week for 3-4 month projects">
          <NumInput value={inp.prepWeeks} onChange={v => update('prepWeeks',v)} className="w-full"/>
        </Field>
        <Field label="Preparation Workload" tip="1.0 = full time">
          <NumInput value={inp.prepWorkload} onChange={v => update('prepWorkload',v)} step={0.1} className="w-full"/>
        </Field>
        <Field label="Preparation Members Count">
          <NumInput value={inp.prepMembers} onChange={v => update('prepMembers',v)} className="w-full"/>
        </Field>
      </Section>

      <Section title="Warranty & UAT">
        <Field label="Warranty Duration (months)">
          <NumInput value={inp.warrantyMonths} onChange={v => update('warrantyMonths',v)} className="w-full"/>
        </Field>
        <Field label="Warranty Team Workload" tip="0.25 = 25%">
          <NumInput value={inp.warrantyWorkload} onChange={v => update('warrantyWorkload',v)} step={0.05} className="w-full"/>
        </Field>
        <Field label="Warranty Team Members">
          <NumInput value={inp.warrantyMembers} onChange={v => update('warrantyMembers',v)} className="w-full"/>
        </Field>
        <Field label="UAT Team Workload" tip="0.25 = 25%">
          <NumInput value={inp.uatWorkload} onChange={v => update('uatWorkload',v)} step={0.05} className="w-full"/>
        </Field>
        <Field label="UAT Team Members">
          <NumInput value={inp.uatMembers} onChange={v => update('uatMembers',v)} className="w-full"/>
        </Field>
      </Section>

      <Section title="Post-Release">
        <Field label="Team Release (hrs/person)" tip="Internal ramp-down time">
          <NumInput value={inp.teamReleaseHoursPerPerson} onChange={v => update('teamReleaseHoursPerPerson',v)} className="w-full"/>
        </Field>
        <Field label="Knowledge Transfer (hours)">
          <NumInput value={inp.knowledgeTransferHours} onChange={v => update('knowledgeTransferHours',v)} className="w-full"/>
        </Field>
      </Section>

      <Section title="Rate & Billing Configuration">
        <Field label="Hours per Month" tip="Working hours per month">
          <NumInput value={inp.hoursPerMonth} onChange={v => update('hoursPerMonth',v)} className="w-full"/>
        </Field>
        <Field label="Client Discount %" tip="Discount off external rate">
          <PctInput value={inp.discount} onChange={v => update('discount',v)} className="w-full"/>
        </Field>
        <Field label="DPM Target %" tip="Desired project margin">
          <PctInput value={inp.dpmTarget} onChange={v => update('dpmTarget',v)} className="w-full"/>
        </Field>
        <Field label="Expenses % of COGS" tip="Auto-calculated if no manual expenses">
          <PctInput value={inp.expensesPctOfCogs} onChange={v => update('expensesPctOfCogs',v)} className="w-full"/>
        </Field>
      </Section>

      <Section title="Project Expenses ($)">
        {Object.entries({equipment:'Equipment Purchase',customerVisit:'Customer Visit',businessTrips:'Business Trips',
          bonuses:'Bonuses',teamBuildings:'Team Buildings',education:'Education',licenses:'Licenses',
          infrastructure:'Infrastructure',other:'Other'}).map(([k,label]) => (
          <Field key={k} label={label}>
            <NumInput value={project.expenses[k]} onChange={v => updateExp(k,v)} step={100} className="w-full"/>
          </Field>
        ))}
      </Section>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB: BUDGET DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function DashboardTab({ project, budget }) {
  const b = budget;

  const phaseData = ['Phase 1','Phase 2','Phase 3'].map(ph => ({
    name: ph.replace('Phase ','P'),
    devHours: b.phaseDevHours[ph]||0,
    stabHours: b.stabilization[ph]||0,
    contHours: b.contingency[ph]||0,
    total: (b.phaseBreakdown[ph]||{}).totalHours||0,
    cost: (b.phaseBreakdown[ph]||{}).cost||0,
    revenue: (b.phaseBreakdown[ph]||{}).revenue||0,
  }));

  return (
    <div className="fade-in">
      <div className="flex items-center justify-between mb-4">
        <div>
          <h2 className="text-lg font-bold">Budget Summary</h2>
          <p className="text-sm text-ink-400">Auto-calculated from team, features, risks and settings</p>
        </div>
        <div className="flex gap-2">
          <button onClick={() => {
            const data = JSON.stringify(project, null, 2);
            const blob = new Blob([data], {type:'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${project.name}-budget.json`; a.click();
          }} className="btn-ghost">ðŸ’¾ Export JSON</button>
        </div>
      </div>

      {/* KEY METRICS */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <MetricCard label="Total Hours" value={fmtHrs(b.totalProjectHours)} sub={`${fmt(b.totalMonths,1)} months`} color="ink"/>
        <MetricCard label="COGS (Total)" value={fmtMoney(b.cogsTotal)} sub={`Billable: ${fmtMoney(b.cogsBillable)}`} color="sea"/>
        <MetricCard label="Revenue (Ext Rate)" value={fmtMoney(b.revenueExtRate)} sub={`Rate: ${fmtMoney(b.avgExtRate)}/hr`} color="mint"/>
        <MetricCard label="DPM" value={fmtPct(b.dpmActual)} sub={`Margin: ${fmtMoney(b.revenueExtRate - b.cogsTotal)}`} color="accent"/>
      </div>

      {/* HOURS BREAKDOWN */}
      <div className="card p-5 mb-4">
        <h3 className="text-sm font-bold text-ink-500 uppercase tracking-wider mb-3">Hours Breakdown</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <table className="w-full text-sm">
              <tbody>
                {[
                  ['Development (Execution)', fmtHrs(b.totalDevHoursExec), 'font-semibold'],
                  ['  Phase 1', fmtHrs(b.phaseDevHours['Phase 1']||0), 'pl-4 text-ink-400'],
                  ['  Phase 2', fmtHrs(b.phaseDevHours['Phase 2']||0), 'pl-4 text-ink-400'],
                  ['  Phase 3', fmtHrs(b.phaseDevHours['Phase 3']||0), 'pl-4 text-ink-400'],
                  ['Stabilization', fmtHrs(b.totalStabilization), ''],
                  ['Contingency Reserve', fmtHrs(b.totalContingency), ''],
                  ['Preparation', fmtHrs(b.prepTotal), ''],
                  ['Post-Release', fmtHrs(b.postReleaseHours), ''],
                  ['  Warranty', fmtHrs(b.warrantyHours), 'pl-4 text-ink-400'],
                  ['  Team Release', fmtHrs(b.teamReleaseHours), 'pl-4 text-ink-400'],
                  ['  UAT', fmtHrs(b.totalUATHours), 'pl-4 text-ink-400'],
                  ['  Knowledge Transfer', fmtHrs(b.knowledgeTransferHours), 'pl-4 text-ink-400'],
                ].map(([label, val, cls], i) => (
                  <tr key={i} className={cls}>
                    <td className="py-1">{label}</td>
                    <td className="py-1 text-right money">{val}</td>
                  </tr>
                ))}
                <tr className="border-t-2 border-ink-900 font-bold text-lg">
                  <td className="pt-2">TOTAL PROJECT</td>
                  <td className="pt-2 text-right money">{fmtHrs(b.totalProjectHours)}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div>
            {/* Visual bar chart */}
            <div className="space-y-2">
              {phaseData.map(p => {
                const maxH = Math.max(...phaseData.map(x => x.total), 1);
                return (
                  <div key={p.name}>
                    <div className="flex justify-between text-xs mb-1">
                      <span className="font-semibold">{p.name}</span>
                      <span className="money">{fmtHrs(p.total)}</span>
                    </div>
                    <div className="h-6 bg-ink-100 rounded-full overflow-hidden flex">
                      <div className="h-full bg-sea rounded-l-full" style={{width:`${(p.devHours/maxH)*100}%`}} title={`Dev: ${fmtHrs(p.devHours)}`}></div>
                      <div className="h-full bg-yellow-400" style={{width:`${(p.stabHours/maxH)*100}%`}} title={`Stabilization: ${fmtHrs(p.stabHours)}`}></div>
                      <div className="h-full bg-red-400 rounded-r-full" style={{width:`${(p.contHours/maxH)*100}%`}} title={`Contingency: ${fmtHrs(p.contHours)}`}></div>
                    </div>
                  </div>
                );
              })}
              <div className="flex gap-4 text-xs mt-2">
                <span className="flex items-center gap-1"><span className="w-3 h-3 bg-sea rounded-sm"></span> Dev</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 bg-yellow-400 rounded-sm"></span> Stabilization</span>
                <span className="flex items-center gap-1"><span className="w-3 h-3 bg-red-400 rounded-sm"></span> Contingency</span>
              </div>
            </div>

            <div className="mt-6">
              <h4 className="text-xs font-semibold text-ink-400 uppercase mb-2">Out of Scope</h4>
              <div className="money text-lg font-bold">{fmtHrs(b.phaseDevHours['Out of Scope']||0)}</div>
            </div>
          </div>
        </div>
      </div>

      {/* FINANCIAL SUMMARY */}
      <div className="card p-5 mb-4">
        <h3 className="text-sm font-bold text-ink-500 uppercase tracking-wider mb-3">Financial Summary</h3>
        <table className="w-full text-sm">
          <thead>
            <tr className="border-b border-ink-200">
              <th className="text-left py-2 text-xs text-ink-400">Metric</th>
              <th className="text-right py-2 text-xs text-ink-400">DPM-based</th>
              <th className="text-right py-2 text-xs text-ink-400">Ext Rate</th>
              <th className="text-right py-2 text-xs text-ink-400">Ext Rate (Disc)</th>
            </tr>
          </thead>
          <tbody>
            <tr><td className="py-2">Revenue</td><td className="text-right money">{fmtMoney(b.revenueDPM)}</td><td className="text-right money">{fmtMoney(b.revenueExtRate)}</td><td className="text-right money">{fmtMoney(b.revenueExtRateDisc)}</td></tr>
            <tr><td className="py-2">COGS</td><td className="text-right money" colSpan={3}>{fmtMoney(b.cogsTotal)}</td></tr>
            <tr><td className="py-2">  of which expenses</td><td className="text-right money text-ink-400" colSpan={3}>{fmtMoney(b.autoExpenses)}</td></tr>
            <tr className="border-t border-ink-200 font-bold">
              <td className="py-2">Gross Profit</td>
              <td className="text-right money">{fmtMoney(b.revenueDPM - b.cogsTotal)}</td>
              <td className="text-right money">{fmtMoney(b.revenueExtRate - b.cogsTotal)}</td>
              <td className="text-right money">{fmtMoney(b.revenueExtRateDisc - b.cogsTotal)}</td>
            </tr>
            <tr>
              <td className="py-2">DPM %</td>
              <td className="text-right money">{b.revenueDPM > 0 ? fmtPct((b.revenueDPM - b.cogsTotal)/b.revenueDPM) : 'â€”'}</td>
              <td className="text-right money">{fmtPct(b.dpmActual)}</td>
              <td className="text-right money">{b.revenueExtRateDisc > 0 ? fmtPct((b.revenueExtRateDisc - b.cogsTotal)/b.revenueExtRateDisc) : 'â€”'}</td>
            </tr>
            <tr>
              <td className="py-2">Revenue per Hour</td>
              <td className="text-right money">{b.totalProjectHours > 0 ? fmtMoney(b.revenueDPM/b.totalProjectHours) : 'â€”'}</td>
              <td className="text-right money">{fmtMoney(b.avgExtRate)}</td>
              <td className="text-right money">{fmtMoney(b.avgExtRateDisc)}</td>
            </tr>
          </tbody>
        </table>
      </div>

      {/* TEAM SUMMARY */}
      <div className="card p-5 mb-4">
        <h3 className="text-sm font-bold text-ink-500 uppercase tracking-wider mb-3">Team Composition</h3>
        <div className="grid grid-cols-3 md:grid-cols-5 gap-3">
          {ROLE_TYPES.filter(r => b.roleGroups[r].count > 0).map(r => (
            <div key={r} className="text-center p-3 rounded-lg bg-ink-50">
              <div className="text-2xl font-bold">{b.roleGroups[r].count}</div>
              <div className="text-xs text-ink-400 font-semibold">{r}</div>
              <div className="text-xs money text-ink-300">{fmtMoney(b.roleAvgRate[r])}/hr</div>
            </div>
          ))}
        </div>
        <div className="mt-3 flex gap-6 text-sm">
          <span><span className="text-ink-400">Total headcount:</span> <strong>{b.totalTeamCount}</strong></span>
          <span><span className="text-ink-400">Avg internal rate:</span> <strong className="money">{fmtMoney(b.teamHourlyRate)}/hr</strong></span>
          <span><span className="text-ink-400">Avg external rate:</span> <strong className="money">{fmtMoney(b.avgExtRate)}/hr</strong></span>
        </div>
      </div>

      {/* TIMELINE */}
      <div className="card p-5">
        <h3 className="text-sm font-bold text-ink-500 uppercase tracking-wider mb-3">Timeline Estimate</h3>
        <div className="grid grid-cols-4 gap-4 text-center">
          <div><div className="text-2xl font-bold">{fmt(project.inputData.prepWeeks, 0)}</div><div className="text-xs text-ink-400">Prep weeks</div></div>
          <div><div className="text-2xl font-bold">{fmt(b.execWeeks, 1)}</div><div className="text-xs text-ink-400">Execution weeks</div></div>
          <div><div className="text-2xl font-bold">{fmt(b.totalWeeks, 1)}</div><div className="text-xs text-ink-400">Total weeks</div></div>
          <div><div className="text-2xl font-bold">{fmt(b.totalMonths, 1)}</div><div className="text-xs text-ink-400">Total months</div></div>
        </div>
      </div>
    </div>
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN APP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function App() {
  const [project, setProject] = useState(() => {
    try {
      const saved = localStorage.getItem('fpp-budget-project');
      if (saved) return JSON.parse(saved);
    } catch(e) {}
    return defaultProject();
  });
  const [activeTab, setActiveTab] = useState('dashboard');

  useEffect(() => {
    try { localStorage.setItem('fpp-budget-project', JSON.stringify(project)); } catch(e) {}
  }, [project]);

  const budget = useMemo(() => calcBudget(project), [project]);

  const tabs = [
    { id:'dashboard', label:'ðŸ“Š Dashboard', icon:'ðŸ“Š' },
    { id:'features', label:'ðŸ§© Features', icon:'ðŸ§©' },
    { id:'team', label:'ðŸ‘¥ Team', icon:'ðŸ‘¥' },
    { id:'risks', label:'âš ï¸ Risks', icon:'âš ï¸' },
    { id:'settings', label:'âš™ï¸ Settings', icon:'âš™ï¸' },
  ];

  const handleImportJSON = () => {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.json';
    input.onchange = (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => { try { setProject(JSON.parse(ev.target.result)); } catch(er) { alert('Invalid JSON file'); } };
      reader.readAsText(file);
    };
    input.click();
  };

  return (
    <div className="min-h-screen">
      {/* HEADER */}
      <header className="bg-ink-950 text-white">
        <div className="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 rounded-lg bg-accent flex items-center justify-center font-bold text-sm">FPP</div>
            <div>
              <input
                type="text" value={project.name}
                onChange={e => setProject(p => ({...p, name: e.target.value}))}
                className="bg-transparent border-none text-white font-bold text-lg focus:outline-none focus:border-b focus:border-accent"
              />
            </div>
          </div>
          <div className="flex items-center gap-2">
            <button onClick={handleImportJSON} className="text-xs text-ink-300 hover:text-white px-3 py-1 border border-ink-700 rounded-lg">ðŸ“‚ Import</button>
            <button onClick={() => {
              if (confirm('Reset all data to defaults?')) setProject(defaultProject());
            }} className="text-xs text-ink-300 hover:text-red-400 px-3 py-1 border border-ink-700 rounded-lg">ðŸ—‘ Reset</button>
          </div>
        </div>
        {/* TAB BAR */}
        <div className="max-w-7xl mx-auto px-4">
          <nav className="flex gap-0">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setActiveTab(t.id)}
                className={`px-5 py-3 text-sm transition-all ${activeTab === t.id ? 'tab-active text-white border-accent' : 'tab-inactive text-ink-400 hover:text-ink-200'}`}>
                {t.label}
              </button>
            ))}
          </nav>
        </div>
      </header>

      {/* CONTENT */}
      <main className="max-w-7xl mx-auto px-4 py-6">
        {activeTab === 'dashboard' && <DashboardTab project={project} budget={budget}/>}
        {activeTab === 'features' && <FeaturesTab project={project} setProject={setProject} budget={budget}/>}
        {activeTab === 'team' && <TeamTab project={project} setProject={setProject}/>}
        {activeTab === 'risks' && <RisksTab project={project} setProject={setProject} budget={budget}/>}
        {activeTab === 'settings' && <InputDataTab project={project} setProject={setProject}/>}
      </main>

      {/* FOOTER */}
      <footer className="border-t border-ink-100 py-4 mt-8">
        <div className="max-w-7xl mx-auto px-4 flex items-center justify-between text-xs text-ink-300">
          <span>Project Budget Calculator â€” FPP v1.0 â€¢ Based on ELEKS FPP Template v7.3</span>
          <span>Data saved in browser localStorage</span>
        </div>
      </footer>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
